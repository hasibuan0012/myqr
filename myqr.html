
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .container {
      margin-top: 40px;
    }
    #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }
    .message {
      margin-top: 20px;
      font-size: 1em;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Scan QR Code</h2>
    <div id="qr-reader"></div>
    <p class="message">Arahkan kamera ke QR berisi <code>username:password</code></p>
  </div>

  <!-- MD5 for CHAP login -->
  <script src="https://cdn.jsdelivr.net/gh/emn178/js-md5/build/md5.min.js"></script>
  <!-- QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    // Hardcoded CHAP values â€” these must be injected dynamically by Mikrotik if used from there
    const chapId = ""; // Will be filled from scanned QR
    const chapChallenge = ""; // Will be filled from scanned QR
    const mikrotikLoginUrl = "http://10.10.2.1/login";

    const html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        const parts = decodedText.split(":");
        if (parts.length >= 2) {
          const username = parts[0];
          const password = parts[1];

          // Create a form dynamically
          const form = document.createElement("form");
          form.method = "post";
          form.action = mikrotikLoginUrl;

          const inputUsername = document.createElement("input");
          inputUsername.type = "hidden";
          inputUsername.name = "username";
          inputUsername.value = username;

          const inputPassword = document.createElement("input");
          inputPassword.type = "hidden";
          inputPassword.name = "password";

          // If CHAP ID and CHAP Challenge are empty, just submit raw password (fallback)
          if (chapId && chapChallenge) {
            inputPassword.value = md5(chapId + password + chapChallenge);
          } else {
            inputPassword.value = password;
          }

          form.appendChild(inputUsername);
          form.appendChild(inputPassword);
          document.body.appendChild(form);
          form.submit();
        }
      },
      (errorMessage) => {
        // Silent error
      }
    ).catch(err => {
      document.querySelector(".message").innerText = "Gagal membuka kamera: " + err;
    });
  </script>
</body>
</html>
